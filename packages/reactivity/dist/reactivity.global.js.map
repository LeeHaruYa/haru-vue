{
  "version": 3,
  "sources": ["../src/index.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/computed.ts", "../src/watch.ts"],
  "sourcesContent": ["import { isFunction } from \"@haru-vue/shared/src\";\n\nexport { effect } from \"./effect\";\nexport { reactive } from \"./reactive\";\nexport { computed } from './computed'\nexport { watch } from './watch'", "export let activeEffect = null as any; \nexport let depsMap = new WeakMap(); // \u4F9D\u8D56Map\n\nexport class ReactiveEffect {\n  public active = true; // \u53EA\u8FD0\u884C\u4E00\u6B21\n  public parent = null;\n  public deps = []; // \u4F9D\u8D56 deps\n  constructor(public fn: Function, public scheduler?) { }\n  run() {\n    if (!this.active) {\n      return this.fn();\n    } else {\n      try {\n        this.parent = activeEffect\n        activeEffect = this;\n        cleanEffect(this);\n        return this.fn();\n      } finally {\n        // \u53D6\u6D88\u5F53\u524D\u6B63\u5728\u8FD0\u884C\u7684effect\n        activeEffect = this.parent;\n        this.parent = null;\n      }\n    }\n  }\n  stop() {\n    if (this.active) {\n      this.active = false;\n      cleanEffect(this);\n    }\n  }\n}\n\nexport function cleanEffect(reactiveEffect) {\n  let deps = reactiveEffect.deps;\n  for (let i = 0; i < deps.length; i++) {\n    deps[i].delete(reactiveEffect)\n  }\n  reactiveEffect.deps.length = 0;\n}\nexport function track(target, key) {\n  if (activeEffect) {\n    let targetMap = depsMap.get(target)\n    if (!targetMap) {\n      depsMap.set(target, targetMap = new Map())\n    }\n    let deps = targetMap.get(key)\n    if (!deps) {\n      targetMap.set(key, deps = new Set())\n    }\n    trackEffects(deps)\n    deps.add(activeEffect);\n  }\n}\n\nexport function trigger(target, key) {\n  let targetMap = depsMap.get(target)\n  if (targetMap) {\n    let deps = targetMap.get(key)\n    if (deps) {\n      triggerEffects(deps)\n    }\n  }\n}\n\nexport function triggerEffects(effects) {\n  if (effects) {\n    effects = new Set(effects)\n    effects.forEach(effect => {\n      if (effect !== activeEffect) { // \u4FDD\u8BC1\u8981\u6267\u884C\u7684effect\u4E0D\u662F\u5F53\u524D\u7684effect\n          if(effect.scheduler){\n              effect.scheduler(); // \u53EF\u4EE5\u63D0\u4F9B\u4E00\u4E2A\u8C03\u5EA6\u51FD\u6570\uFF0C\u7528\u6237\u5B9E\u73B0\u81EA\u5DF1\u7684\u903B\u8F91\n          }else{\n              effect.run(); // \u6570\u636E\u53D8\u5316\u4E86\uFF0C\u627E\u5230\u5BF9\u5E94\u7684effect \u91CD\u65B0\u6267\u884C\n          }\n      }\n  });\n  }\n}\n\nexport function trackEffects(deps) {\n  if (!activeEffect) {\n    return\n  }\n  const shouldTrack = !deps.has(activeEffect);\n  if (shouldTrack) {\n    deps.add(activeEffect);\n    activeEffect.deps.push(deps);\n  }\n}\nexport function effect(fn, options = {} as any) {\n  const _effect = new ReactiveEffect(fn, options.scheduler);\n  _effect.run();\n  const runner = _effect.run.bind(_effect) as any;\n  runner.effect = _effect; // \u66B4\u9732effect\u7684\u5B9E\u4F8B\n  return runner// \u7528\u6237\u53EF\u4EE5\u624B\u52A8\u8C03\u7528runner\u91CD\u65B0\u6267\u884C\n}\n", "export function isObject(val) {\n  return val !== null && typeof val === \"object\";\n}\n\n\nexport function isFunction(val) {\n  return val !== null && typeof val === \"function\";\n}\n", "import { isObject } from \"@haru-vue/shared/src\";\nimport { track, trigger } from \"./effect\";\nimport { reactive } from './reactive'\n\nexport const enum ReactiveFlags {\n    IS_REACTIVE = '__v_isReactive'\n}\n\nexport function isReactive(value) {\n    return value && value[ReactiveFlags.IS_REACTIVE]\n}\n\nexport const baseHandler = {\n    get: function (target, key, receiver) {\n        if (key === ReactiveFlags.IS_REACTIVE) {\n            return true\n        }\n        const res = Reflect.get(target, key, receiver);\n        track(target, key); // \u6536\u96C6\n        if (isObject(res)) {\n            return reactive(res)\n        }\n        return res;\n    },\n    set: function (target, key, value, receiver) {\n        let oldValue = target[key];\n        if (oldValue !== value) {\n            const res = Reflect.set(target, key, value, receiver);\n            trigger(target, key); // \u89E6\u53D1\n            return res;\n        }\n    },\n}", "import { isObject } from \"@haru-vue/shared\";\nimport { isReactive, baseHandler } from './baseHandler'\n\nexport const reactiveMap = new WeakMap();\nexport function reactive(target) {\n  if (!isObject(target)) {\n    return;\n  }\n  if (isReactive(target)) {\n    return target;\n  }\n  const existingProxy = reactiveMap.get(target);\n  if (existingProxy) {\n    return existingProxy;\n  }\n  const proxy = new Proxy(target, baseHandler as object);\n  reactiveMap.set(target, proxy);\n  return proxy;\n}\n", "import { isFunction } from \"@haru-vue/shared\";\n\nimport { activeEffect, ReactiveEffect, trackEffects, triggerEffects } from \"./effect\";\n\n\n\nexport function computed(getterOrOptions) {\n    let isGetter = isFunction(getterOrOptions);\n    let getter, setter;\n    const fn = () => console.warn('computed is readonly ');\n    if (isGetter) {\n        getter = getterOrOptions\n        setter = fn\n    } else {\n        getter = getterOrOptions.get;\n        setter = getterOrOptions.set || fn\n    }\n    return new ComputedRefImpl(getter, setter)\n}\n\nclass ComputedRefImpl {\n    private _value;\n    private _dirty = true;\n    public effect;\n    public deps;\n    private __v_isRef = true;\n    constructor(public getter, public setter) {\n        this.effect = new ReactiveEffect(getter, () => {\n            if (!this._dirty) {\n                this._dirty = true;\n                // \u901A\u77E5\u81EA\u5DF1\u6536\u96C6\u7684effect\u6267\u884C\n                triggerEffects(this.deps)\n            }\n        })\n    }\n    get value() { // \u53EA\u6709\u5F53.value \u7684\u65F6\u5019 dirty\u4E3Atrue\u5C31\u6267\u884C\n        if (activeEffect) {\n            // \u8BA9\u8BA1\u7B97\u5C5E\u6027\u505A\u4F9D\u8D56\u6536\u96C6\n            // \u8BA1\u7B97\u5C5E\u6027 -\u300B effect  set = [effect]\n            trackEffects(this.deps || (this.deps = new Set()))\n        }\n        \n        if (this._dirty) {\n            this._dirty = false\n            this._value = this.effect.run();\n        }\n        return this._value;\n    }\n    set value(newValues) {\n        this.setter(newValues)\n    }\n}\n\n\n\n", "\nimport { isFunction } from \"@haru-vue/shared\";\nimport { isReactive } from \"./baseHandler\";\nimport { activeEffect, ReactiveEffect, trackEffects, triggerEffects } from \"./effect\";\n\n// watch (()=> {},(old, value, newValue)=> {})\nfunction traversal(context) {\n\n}\nexport function watch(context, fn) {\n    let getter\n    if (isReactive(context)) {\n        getter = traversal(context)\n    } else if (isFunction(context)) {\n        getter = context\n    }\n    let oldValue\n    let cleanup;\n    const onCleanup = (fn) => {\n        cleanup = fn;\n    }\n    const setter = () => {\n        cleanup &&  cleanup();\n        let newValue = effect.run()\n        fn(oldValue,newValue, onCleanup)\n        oldValue = newValue;\n    }\n\n    const effect = new ReactiveEffect(getter, setter)\n    // \u9ED8\u8BA4\u8C03\u7528run\u65B9\u6CD5\u4F1A\u6267\u884Cget\u51FD\u6570\uFF0C\u6B64\u65F6source\u4F5C\u4E3A\u4E86\u7B2C\u4E00\u6B21\u7684\u8001\u503C\n    oldValue = effect.run(); // \u9ED8\u8BA4\u6267\u884Cget\u65B9\n\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAO,MAAI,eAAe;AACnB,MAAI,UAAU,oBAAI,QAAQ;AAE1B,MAAM,iBAAN,MAAqB;AAAA,IAI1B,YAAmB,IAAqB,WAAY;AAAjC;AAAqB;AAHxC,WAAO,SAAS;AAChB,WAAO,SAAS;AAChB,WAAO,OAAO,CAAC;AAAA,IACuC;AAAA,IACtD,MAAM;AACJ,UAAI,CAAC,KAAK,QAAQ;AAChB,eAAO,KAAK,GAAG;AAAA,MACjB,OAAO;AACL,YAAI;AACF,eAAK,SAAS;AACd,yBAAe;AACf,sBAAY,IAAI;AAChB,iBAAO,KAAK,GAAG;AAAA,QACjB,UAAE;AAEA,yBAAe,KAAK;AACpB,eAAK,SAAS;AAAA,QAChB;AAAA,MACF;AAAA,IACF;AAAA,IACA,OAAO;AACL,UAAI,KAAK,QAAQ;AACf,aAAK,SAAS;AACd,oBAAY,IAAI;AAAA,MAClB;AAAA,IACF;AAAA,EACF;AAEO,WAAS,YAAY,gBAAgB;AAC1C,QAAI,OAAO,eAAe;AAC1B,aAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK;AACpC,WAAK,GAAG,OAAO,cAAc;AAAA,IAC/B;AACA,mBAAe,KAAK,SAAS;AAAA,EAC/B;AACO,WAAS,MAAM,QAAQ,KAAK;AACjC,QAAI,cAAc;AAChB,UAAI,YAAY,QAAQ,IAAI,MAAM;AAClC,UAAI,CAAC,WAAW;AACd,gBAAQ,IAAI,QAAQ,YAAY,oBAAI,IAAI,CAAC;AAAA,MAC3C;AACA,UAAI,OAAO,UAAU,IAAI,GAAG;AAC5B,UAAI,CAAC,MAAM;AACT,kBAAU,IAAI,KAAK,OAAO,oBAAI,IAAI,CAAC;AAAA,MACrC;AACA,mBAAa,IAAI;AACjB,WAAK,IAAI,YAAY;AAAA,IACvB;AAAA,EACF;AAEO,WAAS,QAAQ,QAAQ,KAAK;AACnC,QAAI,YAAY,QAAQ,IAAI,MAAM;AAClC,QAAI,WAAW;AACb,UAAI,OAAO,UAAU,IAAI,GAAG;AAC5B,UAAI,MAAM;AACR,uBAAe,IAAI;AAAA,MACrB;AAAA,IACF;AAAA,EACF;AAEO,WAAS,eAAe,SAAS;AACtC,QAAI,SAAS;AACX,gBAAU,IAAI,IAAI,OAAO;AACzB,cAAQ,QAAQ,CAAAA,YAAU;AACxB,YAAIA,YAAW,cAAc;AACzB,cAAGA,QAAO,WAAU;AAChB,YAAAA,QAAO,UAAU;AAAA,UACrB,OAAK;AACD,YAAAA,QAAO,IAAI;AAAA,UACf;AAAA,QACJ;AAAA,MACJ,CAAC;AAAA,IACD;AAAA,EACF;AAEO,WAAS,aAAa,MAAM;AACjC,QAAI,CAAC,cAAc;AACjB;AAAA,IACF;AACA,UAAM,cAAc,CAAC,KAAK,IAAI,YAAY;AAC1C,QAAI,aAAa;AACf,WAAK,IAAI,YAAY;AACrB,mBAAa,KAAK,KAAK,IAAI;AAAA,IAC7B;AAAA,EACF;AACO,WAAS,OAAO,IAAI,UAAU,CAAC,GAAU;AAC9C,UAAM,UAAU,IAAI,eAAe,IAAI,QAAQ,SAAS;AACxD,YAAQ,IAAI;AACZ,UAAM,SAAS,QAAQ,IAAI,KAAK,OAAO;AACvC,WAAO,SAAS;AAChB,WAAO;AAAA,EACT;;;AC/FO,WAAS,SAAS,KAAK;AAC5B,WAAO,QAAQ,QAAQ,OAAO,QAAQ;AAAA,EACxC;AAGO,WAAS,WAAW,KAAK;AAC9B,WAAO,QAAQ,QAAQ,OAAO,QAAQ;AAAA,EACxC;;;ACCO,WAAS,WAAW,OAAO;AAC9B,WAAO,SAAS,MAAM;AAAA,EAC1B;AAEO,MAAM,cAAc;AAAA,IACvB,KAAK,SAAU,QAAQ,KAAK,UAAU;AAClC,UAAI,QAAQ,oCAA2B;AACnC,eAAO;AAAA,MACX;AACA,YAAM,MAAM,QAAQ,IAAI,QAAQ,KAAK,QAAQ;AAC7C,YAAM,QAAQ,GAAG;AACjB,UAAI,SAAS,GAAG,GAAG;AACf,eAAO,SAAS,GAAG;AAAA,MACvB;AACA,aAAO;AAAA,IACX;AAAA,IACA,KAAK,SAAU,QAAQ,KAAK,OAAO,UAAU;AACzC,UAAI,WAAW,OAAO;AACtB,UAAI,aAAa,OAAO;AACpB,cAAM,MAAM,QAAQ,IAAI,QAAQ,KAAK,OAAO,QAAQ;AACpD,gBAAQ,QAAQ,GAAG;AACnB,eAAO;AAAA,MACX;AAAA,IACJ;AAAA,EACJ;;;AC7BO,MAAM,cAAc,oBAAI,QAAQ;AAChC,WAAS,SAAS,QAAQ;AAC/B,QAAI,CAAC,SAAS,MAAM,GAAG;AACrB;AAAA,IACF;AACA,QAAI,WAAW,MAAM,GAAG;AACtB,aAAO;AAAA,IACT;AACA,UAAM,gBAAgB,YAAY,IAAI,MAAM;AAC5C,QAAI,eAAe;AACjB,aAAO;AAAA,IACT;AACA,UAAM,QAAQ,IAAI,MAAM,QAAQ,WAAqB;AACrD,gBAAY,IAAI,QAAQ,KAAK;AAC7B,WAAO;AAAA,EACT;;;ACZO,WAAS,SAAS,iBAAiB;AACtC,QAAI,WAAW,WAAW,eAAe;AACzC,QAAI,QAAQ;AACZ,UAAM,KAAK,MAAM,QAAQ,KAAK,uBAAuB;AACrD,QAAI,UAAU;AACV,eAAS;AACT,eAAS;AAAA,IACb,OAAO;AACH,eAAS,gBAAgB;AACzB,eAAS,gBAAgB,OAAO;AAAA,IACpC;AACA,WAAO,IAAI,gBAAgB,QAAQ,MAAM;AAAA,EAC7C;AAEA,MAAM,kBAAN,MAAsB;AAAA,IAMlB,YAAmB,QAAe,QAAQ;AAAvB;AAAe;AAJlC,WAAQ,SAAS;AAGjB,WAAQ,YAAY;AAEhB,WAAK,SAAS,IAAI,eAAe,QAAQ,MAAM;AAC3C,YAAI,CAAC,KAAK,QAAQ;AACd,eAAK,SAAS;AAEd,yBAAe,KAAK,IAAI;AAAA,QAC5B;AAAA,MACJ,CAAC;AAAA,IACL;AAAA,IACA,IAAI,QAAQ;AACR,UAAI,cAAc;AAGd,qBAAa,KAAK,SAAS,KAAK,OAAO,oBAAI,IAAI,EAAE;AAAA,MACrD;AAEA,UAAI,KAAK,QAAQ;AACb,aAAK,SAAS;AACd,aAAK,SAAS,KAAK,OAAO,IAAI;AAAA,MAClC;AACA,aAAO,KAAK;AAAA,IAChB;AAAA,IACA,IAAI,MAAM,WAAW;AACjB,WAAK,OAAO,SAAS;AAAA,IACzB;AAAA,EACJ;;;AC7CA,WAAS,UAAU,SAAS;AAAA,EAE5B;AACO,WAAS,MAAM,SAAS,IAAI;AAC/B,QAAI;AACJ,QAAI,WAAW,OAAO,GAAG;AACrB,eAAS,UAAU,OAAO;AAAA,IAC9B,WAAW,WAAW,OAAO,GAAG;AAC5B,eAAS;AAAA,IACb;AACA,QAAI;AACJ,QAAI;AACJ,UAAM,YAAY,CAACC,QAAO;AACtB,gBAAUA;AAAA,IACd;AACA,UAAM,SAAS,MAAM;AACjB,iBAAY,QAAQ;AACpB,UAAI,WAAWC,QAAO,IAAI;AAC1B,SAAG,UAAS,UAAU,SAAS;AAC/B,iBAAW;AAAA,IACf;AAEA,UAAMA,UAAS,IAAI,eAAe,QAAQ,MAAM;AAEhD,eAAWA,QAAO,IAAI;AAAA,EAE1B;",
  "names": ["effect", "fn", "effect"]
}
